---
import BaseLayout from "@layouts/BaseLayout.astro";
import ArxivIdChip from "@components/ArxivIdChip.astro";
import ProvenancePanel from "@components/ProvenancePanel.astro";
import PaperCard from "@components/PaperCard.astro";
import { readJson, listJsonFiles } from "@utils/data";
import { withBase } from "@utils/withBase";
import { toBibTex } from "@lib/bibtex.js";
import { findRelatedPapers } from "@lib/relatedPapers";

export async function getStaticPaths() {
  const files = await listJsonFiles("papers");
  return files.map((file) => ({ params: { id: file.replace(".json", "") } }));
}

const id = Astro.params.id;
if (!id) {
  throw new Error("Missing paper id");
}
const paper = await readJson(`papers/${id}.json`);
const build = await readJson("provenance/build.json");
const index = await readJson("papers.index.json");
const related = findRelatedPapers({ paper, index, limit: 4 });
const bibtex = toBibTex(paper);
const topicTags = (paper.topic_tags ?? []).map((tag) => tag.topic_id);
const canonicalUrl = Astro.site
  ? new URL(withBase(`/papers/${paper.arxiv_id}`), Astro.site).toString()
  : paper.links.arxiv_abs;
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "ScholarlyArticle",
  headline: paper.title,
  author: paper.authors.map((author) => ({ "@type": "Person", name: author.name ?? author })),
  datePublished: paper.submitted_at,
  dateModified: paper.updated_at,
  identifier: `arXiv:${paper.arxiv_id}`,
  url: canonicalUrl,
  sameAs: paper.links.arxiv_abs,
  publisher: { "@type": "Organization", name: "arXiv" }
};
---
<BaseLayout wide title={`${paper.title} - Causal AI Futures`}>
  <Fragment slot="head">
    <script type="application/ld+json">{JSON.stringify(jsonLd)}</script>
  </Fragment>
  <span data-pagefind-filter="type:paper" hidden></span>
  <span data-pagefind-meta="type" hidden>paper</span>
  <span data-pagefind-meta="title" hidden>{paper.title}</span>
  {(paper.topic_tags ?? []).map((tag) => (
    <span data-pagefind-filter={`topic:${tag.topic_id}`} hidden></span>
  ))}
  <span data-pagefind-filter={`cat:${paper.primary_category}`} hidden></span>
  <section class="section hero">
    <div class="container paper-hero">
      <div>
        <div class="tag-row">
          <ArxivIdChip id={paper.arxiv_id} />
          {paper.categories.map((cat) => (
            <span class="chip secondary">{cat}</span>
          ))}
        </div>
        <h1>{paper.title}</h1>
        <p class="subtle">{paper.authors.map((a) => a.name).join(", ")}</p>
        <div class="tag-row">
          {(paper.topic_tags ?? []).map((tag) => (
            <span class="chip">{tag.topic_id}</span>
          ))}
        </div>
      </div>
      <div class="card">
        <h3>Paper metadata</h3>
        <div class="meta-grid">
          <div>
            <span>Submitted</span>
            <strong>{paper.submitted_at}</strong>
          </div>
          <div>
            <span>Updated</span>
            <strong>{paper.updated_at}</strong>
          </div>
          <div>
            <span>Versions</span>
            <strong>v{paper.metrics.version_count}</strong>
          </div>
        </div>
        <div class="actions">
          <a class="button" href={paper.links.arxiv_abs} target="_blank" rel="noreferrer">arXiv Abstract</a>
          <a class="button secondary" href={paper.links.arxiv_pdf} target="_blank" rel="noreferrer">PDF</a>
        </div>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container glance-grid">
      <div class="card">
        <h2>At a glance</h2>
        <div class="meta-grid">
          <div>
            <span>Submitted</span>
            <strong>{paper.submitted_at}</strong>
          </div>
          <div>
            <span>Updated</span>
            <strong>{paper.updated_at}</strong>
          </div>
          <div>
            <span>Versions</span>
            <strong>v{paper.metrics.version_count}</strong>
          </div>
          <div>
            <span>Primary category</span>
            <strong>{paper.primary_category}</strong>
          </div>
        </div>
        <h3>Topics & categories</h3>
        <div class="tag-row">
          {paper.categories.map((cat) => (
            <span class="chip secondary">{cat}</span>
          ))}
          {topicTags.map((tag) => (
            <span class="chip">{tag}</span>
          ))}
        </div>
        <h3>Version history</h3>
        <div class="versions">
          {paper.versions?.map((version) => (
            <div class="version-row">
              <span class="chip">{version.version}</span>
              <span>{version.updated_at}</span>
            </div>
          ))}
        </div>
      </div>
      <div class="card export-card">
        <h2>Export</h2>
        <div class="section-head">
          <h3>BibTeX</h3>
          <button class="button secondary" data-copy="bibtex">Copy</button>
        </div>
        <pre id="bibtex" class="bibtex">{bibtex}</pre>
        <div class="export-actions">
          <button class="button ghost" data-download="bibtex">Download .bib</button>
          <button class="button ghost" data-download="json">Download JSON</button>
        </div>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container two-col">
      <div class="card">
        <div class="section-head">
          <h2>Abstract</h2>
          <button class="button secondary" data-copy="abstract">Copy</button>
        </div>
        <p id="abstract" class="abstract">{paper.abstract}</p>
      </div>
      <div class="side-rail">
        <ProvenancePanel provenance={build} />
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <h2>Related papers</h2>
      <p class="subtle">Similarity is based on topic overlap and keyword signals, not citations.</p>
      <div class="grid">
        {related.map((item) => (
          <PaperCard paper={item} />
        ))}
      </div>
    </div>
  </section>

  <script is:inline>
    const copyButtons = document.querySelectorAll("[data-copy]");
    copyButtons.forEach((button) => {
      button.addEventListener("click", async () => {
        const targetId = button.dataset.copy;
        const content = document.getElementById(targetId).textContent;
        await navigator.clipboard.writeText(content);
        button.textContent = "Copied";
        setTimeout(() => (button.textContent = "Copy"), 1200);
      });
    });

    const downloadBib = document.querySelector(\"[data-download='bibtex']\");\n    if (downloadBib) {\n      downloadBib.addEventListener(\"click\", () => {\n        const content = document.getElementById(\"bibtex\").textContent;\n        const blob = new Blob([content], { type: \"text/plain\" });\n        const link = document.createElement(\"a\");\n        link.href = URL.createObjectURL(blob);\n        link.download = \"paper.bib\";\n        link.click();\n        URL.revokeObjectURL(link.href);\n      });\n    }\n\n    const downloadJson = document.querySelector(\"[data-download='json']\");\n    if (downloadJson) {\n      downloadJson.addEventListener(\"click\", () => {\n        const content = JSON.stringify(${JSON.stringify(paper)}, null, 2);\n        const blob = new Blob([content], { type: \"application/json\" });\n        const link = document.createElement(\"a\");\n        link.href = URL.createObjectURL(blob);\n        link.download = `${paper.arxiv_id}.json`;\n        link.click();\n        URL.revokeObjectURL(link.href);\n      });\n    }\n   </script>
  </script>

  <style>
    h1 {
      margin: 0.6rem 0 0.6rem;
      font-size: clamp(2rem, 3vw, 3rem);
    }

    .paper-hero {
      display: grid;
      gap: 2rem;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      align-items: start;
    }

    .meta-grid {
      display: grid;
      gap: 0.6rem;
      margin: 1rem 0;
    }

    .meta-grid span {
      text-transform: uppercase;
      font-size: 0.7rem;
      color: var(--muted);
      letter-spacing: 0.08em;
    }

    .meta-grid strong {
      font-size: 0.95rem;
    }

    .actions {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .glance-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: minmax(0, 2fr) minmax(260px, 1fr);
      align-items: start;
    }

    .export-card {
      display: grid;
      gap: 1rem;
    }

    .export-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }

    .two-col {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: minmax(0, 2fr) minmax(260px, 1fr);
    }

    .side-rail {
      display: grid;
      gap: 1rem;
      align-content: start;
    }

    .section-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.8rem;
    }

    .abstract {
      font-family: var(--font-serif);
      line-height: 1.7;
      color: var(--muted);
    }

    .bibtex {
      background: var(--code-bg);
      color: var(--code-text);
      padding: 1rem;
      border-radius: 12px;
      overflow-x: auto;
    }

    .versions {
      display: grid;
      gap: 0.6rem;
      margin-top: 0.6rem;
    }

    .version-row {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    @media (max-width: 900px) {
      .two-col {
        grid-template-columns: 1fr;
      }
    }
  </style>
</BaseLayout>
