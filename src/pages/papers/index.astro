---
import BaseLayout from "@layouts/BaseLayout.astro";
import { readJson } from "@utils/data";
import { withBase } from "@utils/withBase";

const topics = await readJson("taxonomy/topics.json");
const dataUrl = withBase("/data/papers.index.json");
const paperBase = withBase("/papers/");
---
<BaseLayout wide title="Paper Explorer - Causal-AI" description="Browse and filter the causal AI paper corpus.">
  <section class="section hero">
    <div class="container explorer-head">
      <div>
        <h1>Paper Explorer</h1>
        <p class="subtle">Search, filter, and export arXiv-grounded metadata.</p>
      </div>
      <div class="search-block">
        <input id="paper-search" type="search" placeholder="Search title or abstract" />
        <div class="shortcut">Press <span class="kbd">/</span> or <span class="kbd">Cmd+K</span></div>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container explorer-grid">
      <aside class="filters card">
        <h3>Filters</h3>
        <div class="filter-block">
          <strong>Topics</strong>
          <div class="tag-row">
            {topics.map((topic) => (
              <button class="chip secondary" data-topic={topic.id} type="button">{topic.title}</button>
            ))}
          </div>
        </div>
        <div class="filter-block">
          <strong>Sort</strong>
          <select id="sort-select">
            <option value="latest">Latest</option>
            <option value="updated">Recently updated</option>
            <option value="trending">Trending</option>
            <option value="revised">Most revised</option>
          </select>
        </div>
        <div class="filter-block">
          <strong>Metadata</strong>
          <label><input type="checkbox" id="crosslist" /> Cross-listed only</label>
          <label><input type="checkbox" id="multi-version" /> Version count >= 2</label>
        </div>
      </aside>

      <div>
        <div class="results-head">
          <span class="subtle" id="result-count">Loading papers...</span>
          <div class="export-bar">
            <button class="button secondary" data-export="csv">Export CSV</button>
            <button class="button" data-export="bib">Export BibTeX</button>
          </div>
        </div>
        <div class="paper-list" data-list></div>
        <div class="pager">
          <button class="button secondary" data-page="prev">Prev</button>
          <span class="subtle" data-page-status></span>
          <button class="button secondary" data-page="next">Next</button>
        </div>
      </div>
    </div>
  </section>

  <script is:inline>
    const dataUrl = "${dataUrl}";
    const paperBase = "${paperBase}";
    const searchInput = document.getElementById("paper-search");
    const sortSelect = document.getElementById("sort-select");
    const crosslistOnly = document.getElementById("crosslist");
    const multiVersion = document.getElementById("multi-version");
    const topicButtons = Array.from(document.querySelectorAll("[data-topic]"));
    const list = document.querySelector("[data-list]");
    const resultCount = document.getElementById("result-count");
    const pageStatus = document.querySelector("[data-page-status]");
    const pagerButtons = Array.from(document.querySelectorAll("[data-page]"));
    const pageSize = 30;

    let papers = [];
    let filtered = [];
    let activeTopics = new Set();
    let currentPage = 1;

    async function loadPapers() {
      const response = await fetch(dataUrl);
      papers = await response.json();
      applyFilters();
    }

    function applyFilters() {
      const query = (searchInput.value || "").toLowerCase();
      filtered = papers.filter((paper) => {
        const title = paper.title.toLowerCase();
        const abs = paper.abstract.toLowerCase();
        const topics = (paper.topic_tags || []).map((tag) => tag.topic_id);
        const matchesQuery = !query || title.includes(query) || abs.includes(query);
        const matchesTopic = activeTopics.size === 0 || topics.some((t) => activeTopics.has(t));
        const passesCrosslist = !crosslistOnly.checked || Number(paper.metrics.cross_list_count) > 0;
        const passesVersion = !multiVersion.checked || Number(paper.metrics.version_count) >= 2;
        return matchesQuery && matchesTopic && passesCrosslist && passesVersion;
      });

      const sortBy = sortSelect.value;
      filtered.sort((a, b) => {
        if (sortBy === "updated") {
          return new Date(b.updated_at) - new Date(a.updated_at);
        }
        if (sortBy === "trending") {
          return Number(b.metrics.trending_score) - Number(a.metrics.trending_score);
        }
        if (sortBy === "revised") {
          return Number(b.metrics.version_count) - Number(a.metrics.version_count);
        }
        return new Date(b.submitted_at) - new Date(a.submitted_at);
      });

      currentPage = 1;
      renderPage();
    }

    function renderPage() {
      const start = (currentPage - 1) * pageSize;
      const pageItems = filtered.slice(start, start + pageSize);
      list.replaceChildren(...pageItems.map(renderCard));
      resultCount.textContent = `${filtered.length} papers`;
      pageStatus.textContent = `Page ${currentPage} of ${Math.max(1, Math.ceil(filtered.length / pageSize))}`;
    }

    function renderCard(paper) {
      const names = paper.authors.map((author) => (typeof author === "string" ? author : author.name));
      const article = document.createElement("article");
      article.className = "card paper-row";
      article.dataset.id = paper.arxiv_id;
      article.innerHTML = `
        <div class="row-head">
          <input type="checkbox" data-select />
          <div>
            <h3><a href="${paperBase}${paper.arxiv_id}">${paper.title}</a></h3>
            <p class="subtle">${names.slice(0, 3).join(", ")}${names.length > 3 ? ` +${names.length - 3}` : ""}</p>
          </div>
        </div>
        <p class="abstract">${paper.abstract}</p>
        <div class="meta-row">
          <span class="chip">arXiv {paper.arxiv_id}</span>
          <span class="chip">Submitted ${paper.submitted_at}</span>
          <span class="chip secondary">Updated ${paper.updated_at}</span>
          <span class="chip">v${paper.metrics.version_count}</span>
        </div>
        <div class="tag-row">
          ${(paper.topic_tags || []).map((tag) => `<span class="chip secondary">${tag.topic_id}</span>`).join("")}
        </div>
      `;
      return article;
    }

    topicButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const topic = button.dataset.topic;
        if (activeTopics.has(topic)) {
          activeTopics.delete(topic);
          button.classList.remove("active");
        } else {
          activeTopics.add(topic);
          button.classList.add("active");
        }
        applyFilters();
      });
    });

    [searchInput, sortSelect, crosslistOnly, multiVersion].forEach((el) => {
      el.addEventListener("input", applyFilters);
      el.addEventListener("change", applyFilters);
    });

    pagerButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const direction = button.dataset.page;
        const maxPage = Math.max(1, Math.ceil(filtered.length / pageSize));
        if (direction === "prev") currentPage = Math.max(1, currentPage - 1);
        if (direction === "next") currentPage = Math.min(maxPage, currentPage + 1);
        renderPage();
      });
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "/" && document.activeElement !== searchInput) {
        event.preventDefault();
        searchInput.focus();
      }
      if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "k") {
        event.preventDefault();
        searchInput.focus();
      }
    });

    const exportButtons = document.querySelectorAll("[data-export]");
    exportButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const cards = Array.from(document.querySelectorAll("[data-select]"));
        const selected = cards.filter((card) => card.checked).map((card) => card.closest("article"));
        if (selected.length === 0) {
          alert("Select at least one paper.");
          return;
        }
        const type = button.dataset.export;
        if (type === "csv") {
          const rows = ["arxiv_id,title,updated_at,topics"];
          selected.forEach((card) => {
            const id = card.dataset.id;
            const paper = papers.find((item) => item.arxiv_id === id);
            if (!paper) return;
            const title = paper.title.replace(/\"/g, "\"\"");
            const topics = (paper.topic_tags || []).map((tag) => tag.topic_id).join(",");
            rows.push(`${id},\"${title}\",${paper.updated_at},${topics}`);
          });
          download("causal-ai-selection.csv", rows.join("\n"));
        } else {
          const bib = selected
            .map((card) => {
              const id = card.dataset.id;
              const paper = papers.find((item) => item.arxiv_id === id);
              if (!paper) return "";
              return `@article{arxiv:${id},\n  title={${paper.title}},\n  eprint={${id}},\n  archivePrefix={arXiv}\n}`;
            })
            .join("\n\n");
          download("causal-ai-selection.bib", bib);
        }
      });
    });

    function download(filename, content) {
      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    loadPapers();
  </script>

  <style>
    h1 {
      margin: 0 0 0.4rem;
      font-size: clamp(2rem, 3vw, 2.6rem);
    }

    .explorer-head {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      align-items: center;
    }

    .search-block {
      display: grid;
      gap: 0.5rem;
    }

    .search-block input {
      padding: 0.7rem 0.9rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-elevated);
    }

    .shortcut {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .explorer-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: minmax(0, 240px) minmax(0, 1fr);
    }

    .filters {
      display: grid;
      gap: 1rem;
      align-content: start;
    }

    .filter-block {
      display: grid;
      gap: 0.6rem;
    }

    .filter-block label {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.9rem;
    }

    .results-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .export-bar {
      display: flex;
      gap: 0.6rem;
    }

    .paper-list {
      display: grid;
      gap: 1.2rem;
      margin-top: 1rem;
    }

    .paper-row {
      display: grid;
      gap: 0.8rem;
    }

    .row-head {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0.8rem;
      align-items: start;
    }

    .abstract {
      font-family: var(--font-serif);
      color: var(--muted);
      line-height: 1.6;
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .pager {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    @media (max-width: 900px) {
      .explorer-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</BaseLayout>
