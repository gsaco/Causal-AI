---
const { radar = { topics: {} }, topics = [] } = Astro.props;
const axes = [
  { key: "momentum", label: "Momentum" },
  { key: "recency_share", label: "Recency" },
  { key: "cross_list_breadth", label: "Cross-list" },
  { key: "revision_churn", label: "Churn" }
];
const size = 260;
const center = size / 2;
const radius = 90;
const topicIds = topics.length ? topics : Object.keys(radar.topics ?? {});
const colors = ["var(--accent)", "var(--accent-2)", "#38bdf8", "#e879f9", "#22c55e", "#f97316"];

function polygonPoints(metrics) {
  return axes
    .map((axis, index) => {
      const angle = (Math.PI * 2 * index) / axes.length - Math.PI / 2;
      const r = (metrics?.[axis.key] ?? 0) * radius;
      const x = center + r * Math.cos(angle);
      const y = center + r * Math.sin(angle);
      return `${x},${y}`;
    })
    .join(" ");
}
---
<div class="radar">
  <div class="radar-legend">
    {topicIds.map((topicId, index) => (
      <label>
        <input type="checkbox" data-radar-toggle value={topicId} checked />
        <span class="swatch" style={`background:${colors[index % colors.length]}`}></span>
        {topicId}
      </label>
    ))}
  </div>
  <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} class="radar-chart" role="img" aria-label="Trend radar">
    {axes.map((axis, index) => {
      const angle = (Math.PI * 2 * index) / axes.length - Math.PI / 2;
      const x = center + radius * Math.cos(angle);
      const y = center + radius * Math.sin(angle);
      return (
        <g>
          <line x1={center} y1={center} x2={x} y2={y} stroke="var(--border)" />
          <text x={x} y={y} fill="var(--muted)" font-size="10" text-anchor="middle">
            {axis.label}
          </text>
        </g>
      );
    })}
    {[0.33, 0.66, 1].map((scale) => (
      <circle
        cx={center}
        cy={center}
        r={radius * scale}
        fill="none"
        stroke="var(--grid)"
        stroke-dasharray="3 4"
      />
    ))}
    {topicIds.map((topicId, index) => {
      const metrics = radar.topics?.[topicId];
      return (
        <polygon
          points={polygonPoints(metrics)}
          fill={colors[index % colors.length]}
          fill-opacity="0.15"
          stroke={colors[index % colors.length]}
          stroke-width="2"
          data-radar-topic={topicId}
          tabindex="0"
          aria-label={`${topicId} radar`}
        />
      );
    })}
  </svg>
  <div class="radar-note">Signals are normalized; higher values indicate stronger signals.</div>
</div>

<script is:inline>
  const toggles = Array.from(document.querySelectorAll("[data-radar-toggle]"));
  toggles.forEach((toggle) => {
    toggle.addEventListener("change", () => {
      const topic = toggle.value;
      const polygon = document.querySelector(`[data-radar-topic='${topic}']`);
      if (!polygon) return;
      polygon.style.display = toggle.checked ? "" : "none";
    });
  });
</script>

<style>
  .radar {
    display: grid;
    gap: 1rem;
    align-items: start;
    grid-template-columns: minmax(200px, 1fr) minmax(280px, 2fr);
  }

  .radar-legend {
    display: grid;
    gap: 0.5rem;
    font-size: 0.85rem;
  }

  .radar-legend label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .radar-legend input {
    accent-color: var(--accent);
  }

  .swatch {
    width: 10px;
    height: 10px;
    border-radius: 999px;
    display: inline-block;
  }

  .radar-chart {
    width: 100%;
    max-width: 360px;
  }

  .radar-note {
    font-size: 0.8rem;
    color: var(--muted);
    grid-column: 1 / -1;
  }

  @media (max-width: 900px) {
    .radar {
      grid-template-columns: 1fr;
    }
  }
</style>
