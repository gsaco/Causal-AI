---
const { radar = { topics: {} }, topics = [] } = Astro.props;
const axes = [
  { key: "momentum", label: "Momentum" },
  { key: "recency_share", label: "Recency" },
  { key: "cross_list_breadth", label: "Cross-list" },
  { key: "revision_churn", label: "Churn" }
];
const size = 260;
const center = size / 2;
const radius = 90;
const topicEntries = topics.length
  ? topics.map((topic) => ({
      id: topic.id,
      title: topic.title ?? topic.id,
      group: topic.group ?? "Other"
    }))
  : Object.keys(radar.topics ?? {}).map((id) => ({ id, title: id, group: "Other" }));
const topicIds = topicEntries.map((topic) => topic.id);
const colors = ["var(--accent)", "var(--accent-2)", "#38bdf8", "#e879f9", "#22c55e", "#f97316"];
const groups = Array.from(new Set(topicEntries.map((topic) => topic.group)));

function polygonPoints(metrics) {
  return axes
    .map((axis, index) => {
      const angle = (Math.PI * 2 * index) / axes.length - Math.PI / 2;
      const r = (metrics?.[axis.key] ?? 0) * radius;
      const x = center + r * Math.cos(angle);
      const y = center + r * Math.sin(angle);
      return `${x},${y}`;
    })
    .join(" ");
}
---
<div class="radar">
  <div class="radar-legend">
    <div class="radar-controls">
      <input type="search" placeholder="Search topic" data-radar-search />
      <select data-radar-group>
        <option value="all">All groups</option>
        {groups.map((group) => (
          <option value={group}>{group}</option>
        ))}
      </select>
    </div>
    {topicEntries.map((topic, index) => (
      <label data-radar-item data-topic={topic.id} data-group={topic.group} data-title={topic.title.toLowerCase()}>
        <input type="checkbox" data-radar-toggle value={topic.id} checked />
        <span class="swatch" style={`background:${colors[index % colors.length]}`}></span>
        <span class="label">{topic.title}</span>
      </label>
    ))}
  </div>
  <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} class="radar-chart" role="img" aria-label="Trend radar">
    {axes.map((axis, index) => {
      const angle = (Math.PI * 2 * index) / axes.length - Math.PI / 2;
      const x = center + radius * Math.cos(angle);
      const y = center + radius * Math.sin(angle);
      return (
        <g>
          <line x1={center} y1={center} x2={x} y2={y} stroke="var(--border)" />
          <text x={x} y={y} fill="var(--muted)" font-size="10" text-anchor="middle">
            {axis.label}
          </text>
        </g>
      );
    })}
    {[0.33, 0.66, 1].map((scale) => (
      <circle
        cx={center}
        cy={center}
        r={radius * scale}
        fill="none"
        stroke="var(--grid)"
        stroke-dasharray="3 4"
      />
    ))}
    {topicIds.map((topicId, index) => {
      const metrics = radar.topics?.[topicId];
      return (
        <polygon
          points={polygonPoints(metrics)}
          fill={colors[index % colors.length]}
          fill-opacity="0.15"
          stroke={colors[index % colors.length]}
          stroke-width="2"
          data-radar-topic={topicId}
          tabindex="0"
          aria-label={`${topicId} radar`}
        />
      );
    })}
  </svg>
  <div class="radar-note">
    Signals are normalized; higher values indicate stronger signals. This is NOT a measure of paper quality.
  </div>
  <div class="radar-table">
    <table class="table">
      <thead>
        <tr>
          <th>Topic</th>
          <th>Momentum</th>
          <th>Recency</th>
          <th>Cross-list</th>
          <th>Churn</th>
        </tr>
      </thead>
      <tbody>
        {topicEntries.map((topic) => {
          const metrics = radar.topics?.[topic.id] ?? {};
          return (
            <tr>
              <td>{topic.title}</td>
              <td>{(metrics.momentum ?? 0).toFixed(2)}</td>
              <td>{(metrics.recency_share ?? 0).toFixed(2)}</td>
              <td>{(metrics.cross_list_breadth ?? 0).toFixed(2)}</td>
              <td>{(metrics.revision_churn ?? 0).toFixed(2)}</td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>
</div>

<script is:inline>
  const toggles = Array.from(document.querySelectorAll("[data-radar-toggle]"));
  const search = document.querySelector("[data-radar-search]");
  const groupSelect = document.querySelector("[data-radar-group]");
  const items = Array.from(document.querySelectorAll("[data-radar-item]"));
  toggles.forEach((toggle) => {
    toggle.addEventListener("change", () => {
      const topic = toggle.value;
      const polygon = document.querySelector(`[data-radar-topic='${topic}']`);
      if (!polygon) return;
      polygon.style.display = toggle.checked ? "" : "none";
    });
  });

  function applyFilters() {
    const query = (search?.value ?? \"\").toLowerCase();
    const group = groupSelect?.value ?? \"all\";
    items.forEach((item) => {
      const matchesQuery = item.dataset.title?.includes(query) ?? true;
      const matchesGroup = group === \"all\" || item.dataset.group === group;
      const shouldShow = matchesQuery && matchesGroup;
      item.style.display = shouldShow ? \"flex\" : \"none\";
      const toggle = item.querySelector(\"[data-radar-toggle]\");
      const topic = toggle?.value;
      const polygon = topic ? document.querySelector(`[data-radar-topic='${topic}']`) : null;
      if (polygon) {
        polygon.style.display = shouldShow && toggle.checked ? \"\" : \"none\";
      }
    });
  }

  search?.addEventListener(\"input\", applyFilters);
  groupSelect?.addEventListener(\"change\", applyFilters);
</script>

<style>
  .radar {
    display: grid;
    gap: 1rem;
    align-items: start;
    grid-template-columns: minmax(200px, 1fr) minmax(280px, 2fr);
  }

  .radar-legend {
    display: grid;
    gap: 0.5rem;
    font-size: 0.85rem;
  }

  .radar-controls {
    display: grid;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .radar-controls input,
  .radar-controls select {
    padding: 0.45rem 0.6rem;
    border-radius: var(--radius-2);
    border: 1px solid var(--border);
    background: var(--bg-elevated);
    color: var(--text);
  }

  .radar-legend label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.35rem 0.4rem;
    border-radius: 8px;
  }

  .radar-legend label:hover {
    background: var(--surface);
  }

  .label {
    line-height: 1.2;
  }

  .radar-legend input {
    accent-color: var(--accent);
  }

  .swatch {
    width: 10px;
    height: 10px;
    border-radius: 999px;
    display: inline-block;
  }

  .radar-chart {
    width: 100%;
    max-width: 360px;
  }

  .radar-note {
    font-size: 0.8rem;
    color: var(--muted);
    grid-column: 1 / -1;
  }

  .radar-table {
    display: none;
    grid-column: 1 / -1;
  }

  @media (max-width: 900px) {
    .radar {
      grid-template-columns: 1fr;
    }

    .radar-chart {
      display: none;
    }

    .radar-table {
      display: block;
    }
  }
</style>
