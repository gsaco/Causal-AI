---
import { readJson } from "@utils/data";
import { toBibTex } from "@lib/bibtex.js";

const { evidence = [] } = Astro.props;

const entries = await Promise.all(
  evidence.map(async (id) => {
    try {
      const paper = await readJson(`papers/${id}.json`);
      const authors = paper.authors?.map((author) => author.name ?? author).filter(Boolean) ?? [];
      return {
        id,
        title: paper.title,
        year: paper.submitted_at?.slice(0, 4) ?? "",
        authors,
        abs: paper.links?.arxiv_abs ?? `https://arxiv.org/abs/${id}`,
        pdf: paper.links?.arxiv_pdf ?? `https://arxiv.org/pdf/${id}.pdf`,
        bibtex: toBibTex(paper)
      };
    } catch (error) {
      return {
        id,
        title: id,
        year: "",
        authors: [],
        abs: `https://arxiv.org/abs/${id}`,
        pdf: `https://arxiv.org/pdf/${id}.pdf`,
        bibtex: `@article{arxiv:${id},\\n  eprint={${id}},\\n  archivePrefix={arXiv}\\n}`
      };
    }
  })
);
---
<details class="citation">
  <summary class="chip secondary">Evidence ({evidence.length})</summary>
  <div class="citation-panel">
    {entries.map((entry) => (
      <div class="citation-item">
        <div class="citation-meta">
          <strong>{entry.title}</strong>
          <span class="subtle">
            {entry.authors.length ? entry.authors.slice(0, 2).join(", ") : entry.id}
            {entry.year ? ` - ${entry.year}` : ""}
          </span>
        </div>
        <div class="citation-actions">
          <a class="chip" href={entry.abs} target="_blank" rel="noreferrer">Abs</a>
          <a class="chip secondary" href={entry.pdf} target="_blank" rel="noreferrer">PDF</a>
          <button class="chip ghost" type="button" data-copy-bibtex={entry.bibtex}>Copy BibTeX</button>
        </div>
      </div>
    ))}
  </div>
</details>

<script is:inline>
  document.querySelectorAll(\"[data-copy-bibtex]\").forEach((button) => {\n    button.addEventListener(\"click\", async () => {\n      const value = button.getAttribute(\"data-copy-bibtex\");\n      if (!value) return;\n      try {\n        await navigator.clipboard.writeText(value);\n        button.textContent = \"Copied\";\n        setTimeout(() => (button.textContent = \"Copy BibTeX\"), 1500);\n      } catch (error) {\n        console.error(error);\n      }\n    });\n  });\n+</script>

<style>
  .citation {
    position: relative;
  }

  .citation summary {
    list-style: none;
    cursor: pointer;
  }

  .citation summary::-webkit-details-marker {
    display: none;
  }

  .citation-panel {
    position: absolute;
    top: 2.2rem;
    left: 0;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 0.75rem;
    min-width: 260px;
    display: grid;
    gap: 0.75rem;
    box-shadow: 0 12px 24px -18px var(--shadow);
    z-index: 5;
  }

  .citation-item {
    display: grid;
    gap: 0.6rem;
    padding-bottom: 0.6rem;
    border-bottom: 1px solid var(--border);
  }

  .citation-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .citation-meta {
    display: grid;
    gap: 0.2rem;
    font-size: 0.85rem;
  }

  .citation-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }
</style>
