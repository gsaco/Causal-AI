---
import { withBase } from "@utils/withBase";
const pagefindScript = withBase("/pagefind/pagefind.js");
---
<div class="cmdk" data-cmdk hidden>
  <div class="cmdk-backdrop" data-cmdk-close></div>
  <div class="cmdk-panel" role="dialog" aria-modal="true" aria-label="Command palette">
    <div class="cmdk-header">
      <input type="search" placeholder="Search papers, topics, and trends" data-cmdk-input />
      <div class="cmdk-hint">
        <span class="kbd">Esc</span> to close
      </div>
    </div>
    <div class="cmdk-results" data-cmdk-results></div>
  </div>
</div>
<script src={pagefindScript} defer></script>
<script is:inline>
  const palette = document.querySelector("[data-cmdk]");
  const input = document.querySelector("[data-cmdk-input]");
  const results = document.querySelector("[data-cmdk-results]");
  const closeTriggers = document.querySelectorAll("[data-cmdk-close]");
  const openTriggers = document.querySelectorAll("[data-cmdk-open]");

  function openPalette() {
    palette.hidden = false;
    palette.classList.add("open");
    input.focus();
    results.innerHTML = "<p class='subtle'>Type to search the site.</p>";
  }

  function closePalette() {
    palette.classList.remove("open");
    palette.hidden = true;
  }

  closeTriggers.forEach((trigger) => trigger.addEventListener("click", closePalette));
  openTriggers.forEach((trigger) => trigger.addEventListener("click", openPalette));

  document.addEventListener("keydown", (event) => {
    if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "k") {
      event.preventDefault();
      openPalette();
    }
    if (event.key === "Escape" && !palette.hidden) {
      event.preventDefault();
      closePalette();
    }
  });

  palette.addEventListener("keydown", (event) => {
    if (event.key !== "Tab") return;
    const focusable = Array.from(palette.querySelectorAll("input, a, button, [tabindex='0']"))
      .filter((el) => !el.hasAttribute("disabled"));
    if (focusable.length === 0) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (event.shiftKey && document.activeElement === first) {
      event.preventDefault();
      last.focus();
    } else if (!event.shiftKey && document.activeElement === last) {
      event.preventDefault();
      first.focus();
    }
  });

  async function runSearch(query) {
    if (!query) {
      results.innerHTML = "<p class='subtle'>Type to search the site.</p>";
      return;
    }
    if (!window.pagefind) return;
    const search = await window.pagefind.search(query);
    const entries = await Promise.all(search.results.slice(0, 6).map((r) => r.data()));
    results.innerHTML = entries
      .map((entry) => {
        return `
          <a class="cmdk-item" href="${entry.url}">
            <div>
              <strong>${entry.meta.title ?? entry.title}</strong>
              <p>${entry.excerpt}</p>
            </div>
            <span class="chip">${entry.meta.type ?? "result"}</span>
          </a>
        `;
      })
      .join("");
  }

  input.addEventListener("input", (event) => {
    runSearch(event.target.value);
  });

  results.addEventListener("click", (event) => {
    const target = event.target.closest("a");
    if (target) closePalette();
  });
</script>

<style>
  .cmdk {
    position: fixed;
    inset: 0;
    display: grid;
    place-items: center;
    z-index: 50;
  }

  .cmdk-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
  }

  .cmdk-panel {
    position: relative;
    width: min(640px, 90vw);
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1rem;
    box-shadow: 0 24px 40px -30px var(--shadow);
    display: grid;
    gap: 1rem;
  }

  .cmdk-header {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .cmdk-header input {
    flex: 1;
    padding: 0.7rem 0.9rem;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--surface);
  }

  .cmdk-hint {
    font-size: 0.75rem;
    color: var(--muted);
  }

  .cmdk-results {
    display: grid;
    gap: 0.5rem;
    max-height: 320px;
    overflow-y: auto;
  }

  .cmdk-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 0.6rem 0.7rem;
    border-radius: 10px;
  }

  .cmdk-item:hover,
  .cmdk-item:focus {
    background: var(--surface);
  }
</style>
